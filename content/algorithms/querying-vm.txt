queryVm(store, tp, version, originalOffset) {
  snapshot = store.getSnapshot(version).query(tp, originalOffset)
  if (snapshot.getVersion() == version) {
    return snapshot
  }
  
  deletions = store.getDeletionStream(tp, version, NULL)
  
  offset = 0
  do {
    snapshot.offset(originalOffset + offset)
    if (snapshot.hasNext()) {
      offsetTriple = snapshot.next()
      deletions = store.getDeletionsStream(tp, version, offsetTriple)
      if (deletions.hasNext()) {
        offset = deletions.peek().getPosition(tp)
        if (deletions.peek() == offsetTriple) {
          offset += 1
        }
      } else {
        offset = deletions.exactCount()
      }
    }
  } while (snapshot.getCurrentOffset() != originalOffset + offset)
  
  additions = store.getAdditionsStream(tp, version)
  if (!snapshot.hasNext()) {
    additions.offset(snapshot.count(tp) - deletions.exactCount())
  }
  
  return PatchedSnapshotIterator(snapshot, deletions, additions)
}