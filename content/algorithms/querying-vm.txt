queryVm(store, tp, version, originalOffset)  {
  snapshot = store.getSnapshot(version).query(tp, originalOffset)
  if (snapshot.getVersion() == version) {
    return snapshot
  }
  additions = store.getAdditionsStream(tp, version)
  
  loop = true
  while (loop) {
    loop = false
    if (snapshot.hasNext()) {
      offsetTriple = snapshot.next()
      deletions = store.getDeletionsStream(tp, version, offsetTriple)
      if (deletions.hasNext()) {
        offset = deletions.peek().getPosition(tp) + 1
      } else if (deletions.hasPrevious()) {
        offset = deletions.exactCount()
      } else {
        offset = 0
      }
      
      if (snapshot.getCurrentOffset() != originalOffset + offset) {
        snapshot.offset(originalOffset + offset)
        loop = true
      }
    }
  }
  
  return PatchedSnapshotIterator(snapshot, deletions, additions, version)
}